
### Declaraciones pagadas y en cero


``` sql
WITH 
ContribuyentesObligados AS (
    SELECT 
        U.REC,
        U.FECHAINIACTEST,
        O.FECHAINICIO AS FECHAINICIOOBLIGACION,
        F.RFC         AS RFC_FISICO,
        F.NOMBRE,
        F.PRIMERAPELLIDO,
        F.SEGUNDOAPELLIDO,
        M.RFC         AS RFC_MORAL,
        M.DENOMINACION
    FROM RGP_CONTRIBUYENTE U
    LEFT JOIN RGP_P_MORAL M ON U.REC = M.REC
    LEFT JOIN RGP_P_FISICA F ON U.REC = F.REC
    INNER JOIN SGP_USUARIOS K ON U.REC = K.NOMBREUSUARIO
    INNER JOIN RGA_OBLIGACION_CONT O 
        ON U.REC = O.REC 
        AND O.CLAVEOBLIGACION = 24
        AND O.FECHAFIN IS NULL 
        AND U.CLAVESITCONT IN (1, 3)
),
PeriodosVigentes AS (
    SELECT DISTINCT
        J.PERIODO,      -- año calendario (ej. 2023, 2024)
        J.EJERCICIO     -- código del ejercicio (ej. 23, 24)
    FROM INC_CALVIGENCIAS J
    WHERE J.CLAVETIPOOPERSERV = 42
      AND J.EJERCICIO NOT IN (13, 22)
      AND J.PERIODO = 2022
      AND J.FECHAHABIL <= TRUNC(SYSDATE)
),
DeclaracionesValidas AS (
    SELECT DISTINCT
        D.REC,
        D.IDPERIODO AS COD_EJERCICIO ,   
        D.IDEJERCICIO AS COD_PERIODO     
    FROM INT_DECGASES D
    INNER JOIN INC_CALVIGENCIAS A 
        ON A.PERIODO = (D.IDEJERCICIO + 2000)
        AND A.EJERCICIO = D.IDPERIODO
        AND A.CLAVETIPOOPERSERV = 42
    WHERE D.IDEJERCICIO > 13
      AND D.FECHA_REG BETWEEN TIMESTAMP '2016-01-01 00:00:00' AND SYSDATE
      AND (D.IDESTADODEC IN (3, 5) OR (D.IDESTADODEC = 2 AND D.TOTALPAGAR = 0))
)
SELECT 
    'Impuesto a la Emisión de Gases Contaminantes a la Atmósfera' AS DEC,
    C.REC AS REC1,
    P.PERIODO AS EJERCICIO,        -- Año calendario (2023, 2024...)
    P.EJERCICIO AS PERIODO,        -- Código del ejercicio (23, 24...)
    CP.DESCRIPCION AS DESCPERIODO,
    C.RFC_FISICO,
    C.NOMBRE,
    C.PRIMERAPELLIDO,
    C.SEGUNDOAPELLIDO,
    C.RFC_MORAL,
    C.DENOMINACION,
    C.FECHAINIACTEST
FROM ContribuyentesObligados C
CROSS JOIN PeriodosVigentes P
INNER JOIN CAT_PERIODO CP ON P.EJERCICIO = CP.IDPERIODO
LEFT JOIN DeclaracionesValidas DV 
    ON C.REC = DV.REC
    AND P.PERIODO = (DV.COD_PERIODO + 2000)  -- porque DV.COD_PERIODO = 23 → año 2023
    AND P.EJERCICIO = DV.COD_EJERCICIO       -- DV.COD_EJERCICIO = 24 → ejercicio 24
WHERE DV.REC IS NULL
  AND TO_NUMBER(P.PERIODO || LPAD(P.EJERCICIO, 2, '0')) 
        >= TO_NUMBER(TO_CHAR(C.FECHAINICIOOBLIGACION, 'YYYYMM'))
ORDER BY C.REC, P.PERIODO, P.EJERCICIO;

```

### Declaraciones pagadas

```sql
WITH 
ContribuyentesObligados AS (
    SELECT 
        U.REC,
        U.FECHAINIACTEST,
        O.FECHAINICIO AS FECHAINICIOOBLIGACION,
        F.RFC         AS RFC_FISICO,
        F.NOMBRE,
        F.PRIMERAPELLIDO,
        F.SEGUNDOAPELLIDO,
        M.RFC         AS RFC_MORAL,
        M.DENOMINACION
    FROM RGP_CONTRIBUYENTE U
    LEFT JOIN RGP_P_MORAL M ON U.REC = M.REC
    LEFT JOIN RGP_P_FISICA F ON U.REC = F.REC
    INNER JOIN SGP_USUARIOS K ON U.REC = K.NOMBREUSUARIO
    INNER JOIN RGA_OBLIGACION_CONT O 
        ON U.REC = O.REC 
        AND O.CLAVEOBLIGACION = 24
        AND O.FECHAFIN IS NULL 
        AND U.CLAVESITCONT IN (1, 3)
),
PeriodosVigentes AS (
    SELECT DISTINCT
        J.PERIODO,      
        J.EJERCICIO     
    FROM INC_CALVIGENCIAS J
    WHERE J.CLAVETIPOOPERSERV = 42
      AND J.EJERCICIO NOT IN (13, 22)
      AND J.PERIODO = 2022
      AND J.FECHAHABIL <= TRUNC(SYSDATE)
),
DeclaracionesValidas AS (
    SELECT DISTINCT
        D.REC,
        D.IDPERIODO AS COD_EJERCICIO ,   
        D.IDEJERCICIO AS COD_PERIODO     
    FROM INT_DECGASES D
    INNER JOIN INC_CALVIGENCIAS A 
        ON A.PERIODO = (D.IDEJERCICIO + 2000)
        AND A.EJERCICIO = D.IDPERIODO
        AND A.CLAVETIPOOPERSERV = 42
    WHERE D.IDEJERCICIO > 13
      AND D.FECHA_REG BETWEEN TIMESTAMP '2016-01-01 00:00:00' AND SYSDATE
      AND D.IDESTADODEC IN (3, 5) 
)
SELECT 
    'Impuesto a la Emisión de Gases Contaminantes a la Atmósfera' AS DEC,
    C.REC AS REC1,
    P.PERIODO AS EJERCICIO,        
    P.EJERCICIO AS PERIODO,        
    CP.DESCRIPCION AS DESCPERIODO,
    C.RFC_FISICO,
    C.NOMBRE,
    C.PRIMERAPELLIDO,
    C.SEGUNDOAPELLIDO,
    C.RFC_MORAL,
    C.DENOMINACION,
    C.FECHAINIACTEST
FROM ContribuyentesObligados C
CROSS JOIN PeriodosVigentes P
INNER JOIN CAT_PERIODO CP ON P.EJERCICIO = CP.IDPERIODO
LEFT JOIN DeclaracionesValidas DV 
    ON C.REC = DV.REC
    AND P.PERIODO = (DV.COD_PERIODO + 2000)  
    AND P.EJERCICIO = DV.COD_EJERCICIO       
WHERE DV.REC IS NULL
  AND TO_NUMBER(P.PERIODO || LPAD(P.EJERCICIO, 2, '0')) 
        >= TO_NUMBER(TO_CHAR(C.FECHAINICIOOBLIGACION, 'YYYYMM'))
ORDER BY C.REC, P.PERIODO, P.EJERCICIO;
```